"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("tslib"),e=require("@liff/consts"),r=require("@liff/util"),n=require("@liff/store"),i=require("@liff/server-api");function a(n){return t.__awaiter(this,void 0,void 0,(function(){var a,o;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,fetch(i.getEndPoint("permanentLink"),{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"POST",body:JSON.stringify(n)})];case 1:return(a=t.sent()).ok?[3,3]:[4,a.json()];case 2:throw o=t.sent().message,r.createLiffError(e.UNKNOWN,o);case 3:return[4,a.json()];case 4:return[2,t.sent()]}}))}))}var o=function(){function i(){var i=this;this.extraParams="",this.getAndValidateContext=function(){var t=n.getContext();if(!t)throw r.createLiffError(e.INIT_FAILED,"Could not get Context from server.");if(!t.endpointUrl)throw r.createLiffError(e.INIT_FAILED,"Could not get endpointUrl from server.");if(!t.permanentLinkPattern)throw r.createLiffError(e.INIT_FAILED,"Could not get permanentLinkPattern from server.");return t},this.createUrl=function(){var t=i.getAndValidateContext(),a=window.location,o=a.pathname,s=a.search,c=a.hash,f=a.origin,u=new URL(t.endpointUrl);if(u.origin!==f||!i.isAncestor(u.pathname,o))throw r.createLiffError(e.INVALID_CONFIG,"Current page is not under entrypoint.");var l=o.substring(u.pathname.length);l.length>0&&"/"!==l[0]&&(l="/"+l);var h=new RegExp("^".concat(e.CREDENTIAL_KEYS.join("|"))),g=c.substring(1).split("&").filter((function(t){return!h.test(t)&&Boolean(t)})).join("&"),d=g===u.hash.substring(1)?"":g,p=function(t){return t.substring(1).split("&").filter((function(t){return!/liff\.state/.test(t)&&Boolean(t)}))},m=p(s),I=p(u.search);i.extraParams&&m.push(i.extraParams);for(var L=0;L<I.length;L++){var v=I[L],E=m.indexOf(v);E>-1&&m.splice(E,1)}var _=m.join("&"),w="".concat(l).concat(""!==_?"?".concat(_):"").concat(d?"#".concat(d):"");return"".concat(e.PERMANENT_LINK_ORIGIN).concat(n.getConfig().liffId).concat(w)},this.createUrlBy=function(o){return t.__awaiter(i,void 0,void 0,(function(){var i,s;return t.__generator(this,(function(t){switch(t.label){case 0:if(!(i=n.getConfig().liffId))throw r.createLiffError(e.INIT_FAILED,"Should run after liff init.");try{s=new URL(o)}catch(c){throw r.createLiffError(e.INVALID_ARGUMENT,"invalid URL.")}return[4,a({liffId:i,currentPageUrl:s.toString()})];case 1:return[2,t.sent().permanentLinkUrl]}}))}))},this.setExtraQueryParam=function(t){i.extraParams=t},this.isAncestor=function(t,e){return 0===e.indexOf(t)&&(t.endsWith("/")&&(t=t.substring(0,t.length-1)),void 0===e[t.length]||"/"===e[t.length])},this.install=function(){return{createUrl:i.createUrl,createUrlBy:i.createUrlBy,setExtraQueryParam:i.setExtraQueryParam}}}return Object.defineProperty(i.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),i}(),s=new o;exports.PermanentLink=o,exports.module=s;
