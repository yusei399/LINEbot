import{__awaiter as t,__generator as n}from"tslib";import{UNKNOWN as r,INIT_FAILED as e,INVALID_CONFIG as i,CREDENTIAL_KEYS as o,PERMANENT_LINK_ORIGIN as a,INVALID_ARGUMENT as s}from"@liff/consts";import{createLiffError as c}from"@liff/util";import{getContext as f,getConfig as u}from"@liff/store";import{getEndPoint as l}from"@liff/server-api";function h(e){return t(this,void 0,void 0,(function(){var t,i;return n(this,(function(n){switch(n.label){case 0:return[4,fetch(l("permanentLink"),{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"POST",body:JSON.stringify(e)})];case 1:return(t=n.sent()).ok?[3,3]:[4,t.json()];case 2:throw i=n.sent().message,c(r,i);case 3:return[4,t.json()];case 4:return[2,n.sent()]}}))}))}var p=function(){function r(){var r=this;this.extraParams="",this.getAndValidateContext=function(){var t=f();if(!t)throw c(e,"Could not get Context from server.");if(!t.endpointUrl)throw c(e,"Could not get endpointUrl from server.");if(!t.permanentLinkPattern)throw c(e,"Could not get permanentLinkPattern from server.");return t},this.createUrl=function(){var t=r.getAndValidateContext(),n=window.location,e=n.pathname,s=n.search,f=n.hash,l=n.origin,h=new URL(t.endpointUrl);if(h.origin!==l||!r.isAncestor(h.pathname,e))throw c(i,"Current page is not under entrypoint.");var p=e.substring(h.pathname.length);p.length>0&&"/"!==p[0]&&(p="/"+p);var m=new RegExp("^".concat(o.join("|"))),d=f.substring(1).split("&").filter((function(t){return!m.test(t)&&Boolean(t)})).join("&"),g=d===h.hash.substring(1)?"":d,v=function(t){return t.substring(1).split("&").filter((function(t){return!/liff\.state/.test(t)&&Boolean(t)}))},w=v(s),x=v(h.search);r.extraParams&&w.push(r.extraParams);for(var U=0;U<x.length;U++){var y=x[U],b=w.indexOf(y);b>-1&&w.splice(b,1)}var P=w.join("&"),j="".concat(p).concat(""!==P?"?".concat(P):"").concat(g?"#".concat(g):"");return"".concat(a).concat(u().liffId).concat(j)},this.createUrlBy=function(i){return t(r,void 0,void 0,(function(){var t,r;return n(this,(function(n){switch(n.label){case 0:if(!(t=u().liffId))throw c(e,"Should run after liff init.");try{r=new URL(i)}catch(o){throw c(s,"invalid URL.")}return[4,h({liffId:t,currentPageUrl:r.toString()})];case 1:return[2,n.sent().permanentLinkUrl]}}))}))},this.setExtraQueryParam=function(t){r.extraParams=t},this.isAncestor=function(t,n){return 0===n.indexOf(t)&&(t.endsWith("/")&&(t=t.substring(0,t.length-1)),void 0===n[t.length]||"/"===n[t.length])},this.install=function(){return{createUrl:r.createUrl,createUrlBy:r.createUrlBy,setExtraQueryParam:r.setExtraQueryParam}}}return Object.defineProperty(r.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),r}(),m=new p;export{p as PermanentLink,m as module};
