import{__awaiter as t,__generator as n,__values as e,__spreadArray as r,__read as i}from"tslib";import{PERMISSION_NAMES as o,INVALID_ARGUMENT as s,UNAUTHORIZED as a,FORBIDDEN as c,UNKNOWN as u}from"@liff/consts";import{createLiffError as f,extractChannelIdFromLiffId as l}from"@liff/util";import{getContext as h,getAccessToken as p,getConfig as d,setAccessToken as v}from"@liff/store";import{verifyAccessToken as m,fetch as w,getEndPoint as b}from"@liff/server-api";import{isInClient as y}from"@liff/is-in-client";import{subWindow as C}from"@liff/sub-window";import{isApiAvailable as g}from"@liff/is-api-available";function I(r){return t(this,void 0,void 0,(function(){var t,i,c,u,l,d,v;return n(this,(function(n){switch(n.label){case 0:return function(t){if(!o.includes(t))throw f(s,"Unexpected permission name.");var n=h();return!!(null==n?void 0:n.scope.includes(t))}(r)?(t=p())?[4,m(t)]:[3,2]:[2,{state:"unavailable"}];case 1:i=n.sent(),c=unescape(i.scope).split(" ");try{for(u=e(c),l=u.next();!l.done;l=u.next())if(l.value.includes(r))return[2,{state:"granted"}]}catch(w){d={error:w}}finally{try{l&&!l.done&&(v=u.return)&&v.call(u)}finally{if(d)throw d.error}}return[2,{state:"prompt"}];case 2:throw f(a,"LiffId is not found.")}}))}))}function k(){var t,n,e=h();return!!e&&("square_chat"!==e.type&&(g("skipChannelVerificationScreen")||!y()&&(null===(n=null===(t=e.availability)||void 0===t?void 0:t.skipChannelVerificationScreen)||void 0===n?void 0:n.permission)))}function j(){var t=d().liffId;if(t)return w("".concat(b("unauthorizedPermissions"),"?liffId=").concat(t),{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer ".concat(p())}});throw f(a,"liffId is required")}var A,S=C.on,T=C.off,q=C.open,x=function(){function e(e,r){var i=this;this.onSubmit=function(e){var r=e.newAccessToken,o=e.ICA_ERROR;return t(i,void 0,void 0,(function(){return n(this,(function(t){return r?this.resolve({newAccessToken:r}):o&&this.reject(f(u,o)),this.teardown(),[2]}))}))},this.onClose=function(){return t(i,void 0,void 0,(function(){return n(this,(function(t){return this.reject(f(a,"user didn't allow the agreement")),this.teardown(),[2]}))}))},this.onCancel=function(){return t(i,void 0,void 0,(function(){return n(this,(function(t){return this.reject(f(a,"user didn't allow the agreement")),this.teardown(),[2]}))}))},this.onError=function(e){return t(i,void 0,void 0,(function(){return n(this,(function(t){return this.reject(e),this.teardown(),[2]}))}))},this.resolve=e,this.reject=r,this.setup()}return e.prototype.setup=function(){S("submit",this.onSubmit),S("close",this.onClose),S("cancel",this.onCancel),S("error",this.onError)},e.prototype.teardown=function(){T("submit",this.onSubmit),T("close",this.onClose),T("cancel",this.onCancel),T("error",this.onError),A=void 0},e.prototype.open=function(){var t=d().liffId;t?q({url:"".concat("https://liff.line.me/1656032314-Xgrw5Pmk"),appData:{liffId:t,channelId:l(t),accessToken:p()}}):this.reject(f(a,"liffId is required"))},e}();function E(){return t(this,void 0,void 0,(function(){var t,e;return n(this,(function(n){switch(n.label){case 0:if(!k())throw f(c,"SkipChannelVerificationScreen is unavailable.");return A&&A.teardown(),[4,j()];case 1:return t=n.sent(),(y()?t:t.filter((function(t){return"chat_message.write"!==t}))).length>0?[4,new Promise((function(t,n){(A=new x(t,n)).open()}))]:[3,3];case 2:return e=n.sent().newAccessToken,v(e),[3,4];case 3:throw f(c,"All permissions have already been approved.");case 4:return[2]}}))}))}function P(e,o){var s=this;return function(){for(var a=[],u=0;u<arguments.length;u++)a[u]=arguments[u];return t(s,void 0,void 0,(function(){var t,s,u;return n(this,(function(n){switch(n.label){case 0:return t=(a.length>0?a[a.length-1]:{}).ignorePermissionCheck,s=void 0!==t&&t,[4,I(o)];case 1:if("unavailable"!==(u=n.sent().state))return[3,2];throw f(c,"The permission is not in LIFF app scope.");case 2:return"prompt"!==u||!k()||s||!y()&&"chat_message.write"===o?[3,4]:[4,E()];case 3:return n.sent(),[3,5];case 4:s&&a.pop(),n.label=5;case 5:return[4,e.apply(void 0,r([],i(a),!1))];case 6:return[2,n.sent()]}}))}))}}var _=function(){function t(){this.name="permission"}return t.prototype.install=function(){return{query:I,requestAll:E}},t}(),R=new _;export{_ as PermissionModule,P as attachChecker,R as module};
