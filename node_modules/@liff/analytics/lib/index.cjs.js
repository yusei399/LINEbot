"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/consts"),i=require("@liff/logger"),s=require("@liff/util"),r=require("@liff/store"),n=require("@liff/get-version"),o=require("@liff/is-logged-in"),u=require("@liff/get-profile");function a(){return e.__awaiter(this,void 0,void 0,(function(){var t,s;return e.__generator(this,(function(e){switch(e.label){case 0:if(!o.isLoggedIn())return[3,6];e.label=1;case 1:return e.trys.push([1,5,,6]),(t=r.getDecodedIDToken())&&t.sub?[2,t.sub]:[3,2];case 2:return[4,u.getProfile()];case 3:if((s=e.sent())&&s.userId)return[2,s.userId];e.label=4;case 4:return[3,6];case 5:return e.sent(),i.logger.debug("can't retrieve Mid/Uid because of something wrong"),[3,6];case 6:return[2]}}))}))}function f(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,a()];case 1:return(t=e.sent())&&"u"===t.substring(0,1)?[2,t]:[2]}}))}))}var c=function(){function u(){this.utsExtra={isLiffSuccessful:!1,isLoggedIn:!1,id:"",version:""},this.injected=!1}return Object.defineProperty(u,"CUSTOMPLACEID_INIT",{get:function(){return"liff.init"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"CUSTOMTYPE",{get:function(){return"liffSdk"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"LiffUtsLoginStatus",{get:function(){return{isLoggedIn:1,isLiffSuccessful:2}},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"name",{get:function(){return"analytics"},enumerable:!1,configurable:!0}),u.prototype.install=function(e){var t=e.liff,i=e.internalHooks;this.liffCore=t,i.init.beforeFinished(this.beforeInitFinished.bind(this)),i.init.beforeSuccess(this.beforeInitSuccess.bind(this)),i.init.error(this.initError.bind(this))},u.prototype.changeRatioToUTSFormat=function(e){if(e&&Number.isFinite(e))return Math.round(100*e)},u.prototype.setExtra=function(){var e,t=this.utsExtra,i=t.isLiffSuccessful,s=t.isLoggedIn,r=t.id,n=t.version,o=(s?u.LiffUtsLoginStatus.isLoggedIn:0)|(i?u.LiffUtsLoginStatus.isLiffSuccessful:0);null===(e=this.uts)||void 0===e||e.setExtra("liff",{id:r,loginStatus:o,version:n})},u.prototype.assignUtsExtra=function(e){Object.assign(this.utsExtra,e)},u.prototype.setVersion=function(e){this.assignUtsExtra({version:e}),i.logger.debug("[LIFFUTS][SDK version] ".concat(e)),this.setExtra()},u.prototype.setLiffId=function(e){this.assignUtsExtra({id:e}),i.logger.debug("[LIFFUTS][LIFFID] ".concat(e)),this.setExtra()},u.prototype.setIsLoggedIn=function(e){this.assignUtsExtra({isLoggedIn:e}),i.logger.debug("[LIFFUTS][isLoggedIn] ".concat(e)),this.setExtra()},u.prototype.sendLiffInit=function(){var e;i.logger.debug("[LIFFUTS][sendCustom] liff.init"),null===(e=this.uts)||void 0===e||e.sendCustom({type:u.CUSTOMTYPE,params:{placeId:u.CUSTOMPLACEID_INIT}})},u.prototype.setIsLiffSuccessful=function(e){this.assignUtsExtra({isLiffSuccessful:e}),i.logger.debug("[LIFFUTS][isLiffInitSuccessful] ".concat(e)),this.setExtra()},u.prototype.prepareReferrer=function(e){var i={};Object.keys(e).forEach((function(s){if(t.UTS_REFERRER_QUERY.includes(s)){var r=e[s];"string"==typeof r&&r&&(i[s.replace(/^liff\.ref\./,"")]=r)}})),Object.keys(i).length>0&&(this.referrer=i)},u.prototype.beforeInitFinished=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,u,a,c,g,l,d,h,p,I,b,L;return e.__generator(this,(function(S){switch(S.label){case 0:if(t=s.qs.parse(window.location.search),this.prepareReferrer(t),u=r.getContext(),!(a=null==u?void 0:u.utsTracking))return[2];if(c=r.getConfig(),g=c.liffId,l=c.analytics,"auto"!==a.mode||!l)return[3,6];i.logger.debug("[LIFFUTS] ".concat((new Date).toUTCString())),S.label=1;case 1:return S.trys.push([1,3,,4]),d=this,[4,new Promise((function(e,t){var i=window.uts,s=document.createElement("script");s.type="text/javascript",s.src="https://static.line-scdn.net/uts/edge/4.1.0/uts.js",s.onload=function(){var t=window.uts;e(t),window.uts=i},s.onerror=function(e){t(e)},document.getElementsByTagName("head")[0].appendChild(s)}))];case 2:return d.uts=S.sent(),[3,4];case 3:return h=S.sent(),i.logger.debug("[LIFFUTS] cannot load UTS, reason: ".concat(h)),[2];case 4:return p=e.__assign(e.__assign({},l.context),{utsId:l.context.utsId,appName:l.context.appName,appEnv:l.context.appEnv||"release"}),I=e.__assign(e.__assign({endpoint:"https://uts-front.line-apps.com"},l.options),{sampleRate:this.changeRatioToUTSFormat(a.sendRatio),version:"current"}),this.uts.init(p,I),[4,f()];case 5:(b=S.sent())&&(i.logger.debug("[LIFFUTS][mid] ".concat(b)),this.uts.setMid(b)),(null==u?void 0:u.tid)&&(i.logger.debug("[LIFFUTS][tid] ".concat(u.tid)),this.uts.setTid(u.tid)),this.referrer&&(i.logger.debug("liff.ref.referrer",this.referrer),this.uts.setSessionParams(this.referrer)),g&&this.setLiffId(g),this.setIsLoggedIn(o.isLoggedIn()),this.setVersion(n.getVersion()),L=s.removeCredential(location.href),i.logger.debug("[LIFFUTS][url] ".concat(L)),this.uts.setUrl(L),this.liffCore.analytics=this.uts,this.injected=!0,S.label=6;case 6:return[2]}}))}))},u.prototype.beforeInitSuccess=function(){return this.injected&&(this.setIsLiffSuccessful(!0),this.sendLiffInit()),Promise.resolve()},u.prototype.initError=function(){return this.injected&&(this.setIsLiffSuccessful(!1),this.sendLiffInit()),Promise.resolve()},u}();exports.AnalyticsModule=c,exports.sendShareTargetPicker=function(e){i.logger.debug("[LIFFUTS][sendCustom] liff.shareTargetPicker"),e.sendCustom({type:"liffSdk",params:{placeId:"liff.shareTargetPicker"}})};
